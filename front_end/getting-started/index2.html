<!doctype html>

<html>

<head>
    <title>seeker</title>
    <script src="cythoscape.min.js"></script>
    <script src="jquery.min.js"></script>
</head>

<style>
    #cy {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0px;
        left: 0px;
    }
</style>

<body>
    <div id="cy"></div>
    <script>
        window.set = new Set();

        function initCriminal(quantity) {
            if (isGraphFull()) {
                return;
            }
            while (quantity > 0) {
                quantity--;
                var position = getRandomPosition();
                window.criminal = {
                    id: 'crim',
                    position: position
                }
                console.log("Criminal position: " + position);
                cy.style()
                    .selector('#' + position)
                    .style({
                        'background-color': 'red'
                    })
                    .update();
            }
        }
        function initPolice(quantity) {
            if (isGraphFull()) {
                return;
            }
            while (quantity > 0) {
                quantity--;
                position = getRandomPosition();
                set.add(position);
                window.police = {
                    id: 'police',
                    position: position
                }
                console.log("Police position: " + position);
                cy.style()
                    .selector('#' + position)
                    .style({
                        'background-color': 'blue'
                    })
                    .update();
            }
        }
        function getRandomPosition() {
            var position;
            do {
                position = Math.floor((Math.random() * responseNodes.length));
            }
            while (set.has(position));
            set.add(position);
            return position
        }

        function isGraphFull() {
            if (set.size >= responseNodes.length) {
                return true;
            } else {
                return false;
            }
        }

        function placeEdgeLabels() {
            responseGraph.forEach(edge => {
                var edge_id = '#' + edge.begin.toString() + '_' + edge.end.toString();
                cy.style()
                    .selector(edge_id)
                    .style({
                        'label': edge.weight.toString()
                    }).update();
            });
        }

        // function animateTransition() {
        //     cy.nodes('#1').animate({
        //             style: { backgroundColor: 'yellow' }
        //         }, {
        //                 duration: 1000
        //             });
        //             cy.edges('#2_1').animate({
        //                     style: { 'line-color': 'yellow' }
        //                 }, {
        //                         duration : 1000
        //                     });
        //                 }

        function animateTransition(idNode1, idNode2, peso, type){
            var animDuration = peso * 600;
            var color = null;
            if(type == 'police'){
                color = 'blue';
            }
            else if(type == 'crim'){
                color = 'red';
            }
            cy.nodes('#'+idNode1).animate({
                style: {backgroundColor: 'grey'}
            }, {
                    duration: animDuration
                }
            );

            console.log(cy.nodes('#'+idNode1));
            

            cy.edges('#'+idNode1+'_'+idNode2).animate({
                style: {'line-color': color}
            }, {
                duration: animDuration
                }
            );

            cy.nodes('#'+idNode2).animate({
                style: {backgroundColor: color}
            }, {
                    duration: animDuration
                }
            );

            cy.edges('#'+idNode1+'_'+idNode2).animate({
                style: {'line-color': 'grey'}
            }, {
                duration: animDuration
                }
            );

            console.log(cy.edges('#'+idNode1+'_'+idNode2));
            
        }

        jQuery.ajax({
            url: 'http://127.0.0.1:5000/graph/clean',
            success: function (result) {
                window.responseGraph = result.graph.arcList;
                window.responseNodes = result.nodes;
                window.responseElements = [];
                responseNodes.forEach(node => {
                    responseElements.push(
                        {
                            data: { id: node.toString() }
                        }
                    );
                });
                responseGraph.forEach(edge => {
                    if (edge.begin != edge.end) {
                        var data_id = edge.begin.toString() + '_' + edge.end.toString();
                        responseElements.push(
                            {
                                data: {
                                    id: data_id,
                                    source: edge.begin.toString(),
                                    target: edge.end.toString()
                                }
                            }
                        );
                    }
                });
                window.cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: responseElements,
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'label': 'data(id)',
                                shape: 'ellipse',
                            },
                        }
                    ]
                });
                initCriminal(1);
                initPolice(2);
                placeEdgeLabels();
                animateTransition();
                //Inserir c√≥digo a partir daqui
            }
        });

    </script>
</body>

</html>