<!doctype html>

<html>

<head>
    <title>seeker</title>
    <script src="jquery.min.js"></script>
    <script src="cythoscape.min.js"></script>
</head>

<style>
    #cy {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0px;
        left: 0px;
    }
</style>

<body>
    <div id="cy"></div>
    <script>
        window.set = new Set();
        var lastPosition = -1;
        function initCriminal(quantity) {
            if (isGraphFull()) {
                return;
            }
            while (quantity > 0) {
                quantity--;
                var position = getRandomPosition();
                window.criminal = {
                    id: 'crim',
                    position: position
                }
                console.log("Criminal position: " + position);
                cy.style()
                    .selector('#' + position)
                    .style({
                        'background-color': 'red'
                    })
                    .update();
            }
        }
        function initPolice(quantity) {
            if (isGraphFull()) {
                return;
            }
            while (quantity > 0) {
                quantity--;
                policeCount++;
                position = getRandomPosition();
                set.add(position);
                window.police = {
                    id: 'police' + policeCount.toString(),
                    position: position
                }
                console.log("Police position: " + position);
                cy.style()
                    .selector('#' + position)
                    .style({
                        'background-color': 'blue'
                    })
                    .update();
            }
            console.log(policeCount);
        }
        function getRandomPosition() {
            var position;
            do {
                position = Math.floor((Math.random() * responseNodes.length));
            }
            while (set.has(position));
            set.add(position);
            return position
        }

        function isGraphFull() {
            if (set.size >= responseNodes.length) {
                return true;
            } else {
                return false;
            }
        }

        function placeEdgeLabels() {
            responseGraph.forEach(edge => {
                var edge_id = '#' + edge.begin.toString() + '_' + edge.end.toString();
                cy.style()
                    .selector(edge_id)
                    .style({
                        'label': edge.weight.toString()
                    }).update();
            });
        }

        function turnOnNode(idNode1, idNode2, time, color){
            cy.nodes('#' + idNode2).animate({
                style: { backgroundColor: color }
            }, {
                duration: time
            }
            );
        }        

        function turnOffLine(idNode1, idNode2, time, color){
            cy.edges('#' + idNode1 + '_' + idNode2).animate({
                style: { 'line-color': "grey" }
            }, {
                duration: time
            }, {
                complete : turnOnNode(idNode1, idNode2, time, color)
            }
            );
        }

        function turnOnLine(idNode1, idNode2, time, color){
            cy.edges('#' + idNode1 + '_' + idNode2).animate({
                style: { 'line-color': color }
            }, {
                duration: time
            }, {
                complete : turnOffLine(idNode1, idNode2, time, color)
            }
            );
        }

        function turnOffNode(idNode1, idNode2, time, color){
            cy.nodes('#' + idNode1).animate({
                style: { backgroundColor: 'grey' }
            }, {
                duration: time
            },{
                complete : turnOnLine(idNode1,idNode2,time,color)
            }
            );
        }

        function animateTransition(idNode1, idNode2, peso, type) {
            console.log(peso);
            var animDuration = peso * 1000;
            animationPartTime = animDuration/4;
            
            var color = null;
            if (type == 'police') {
                color = 'blue';
            }
            else if (type == 'crim') {
                color = 'red';
            }
            console.log(animationPartTime);
            turnOffNode(idNode1, idNode2, animationPartTime, color)
        }

        function createRandomMovement(actualPosition) {
            var newPosition = position = Math.floor((Math.random() * graph_list[actualPosition].length));
            return graph_list[actualPosition][newPosition];
        }

        function moveCriminal() {
            var pos;
            var weight;
            var actualPosition;
            var newPosition;
            for (var i = 0; i < 1; i++) {
                actualPosition = criminal.position;
                do{
                    newPosition = createRandomMovement(criminal.position);
                }while(newPosition == lastPosition);
                if (graph_matrix[actualPosition][newPosition] != 'null') {
                    weight = graph_matrix[actualPosition][newPosition];
                }
                else if (graph_matrix[newPosition][actualPosition] != 'null') {
                    weight = graph_matrix[newPosition][actualPosition];
                }
                lastPosition = actualPosition;
                criminal.position = newPosition;
                console.log("Actual: " + actualPosition);
                console.log("New " + newPosition);
                console.log("Weight " + weight);
                animateTransition(actualPosition, newPosition, weight, "crim")
            }
        }

        jQuery.ajax({
            url: 'http://127.0.0.1:5000/graph/clean/',
            success: function (result) {
                window.responseGraph = result.graph.arcList;
                window.responseNodes = result.nodes;
                window.graph_matrix = result.graph_matrix;
                window.graph_list = result.graph_list;
                window.floyd = result.floyd;
                window.dist = result.dist;
                window.responseElements = [];
                window.policeCount = 0;
                responseNodes.forEach(node => {
                    responseElements.push(
                        {
                            data: { id: node.toString() }
                        }
                    );
                });
                responseGraph.forEach(edge => {
                    if (edge.begin != edge.end) {
                        var data_id = edge.begin.toString() + '_' + edge.end.toString();
                        responseElements.push(
                            {
                                data: {
                                    id: data_id,
                                    source: edge.begin.toString(),
                                    target: edge.end.toString()
                                }
                            }
                        );
                    }
                });
                window.cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: responseElements,
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'label': 'data(id)',
                                shape: 'ellipse',
                            },
                        }
                    ]
                });

                initCriminal(1);
                initPolice(2);
                placeEdgeLabels();
                moveCriminal();
                //Inserir c√≥digo a partir daqui
            }
        });

    </script>
</body>

</html>