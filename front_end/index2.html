<!doctype html>

<html>

<head>
    <meta charset="UTF-8">
    <title>seeker</title>
    <script src="jquery.min.js"></script>
    <script src="cythoscape.min.js"></script>
    <script src="euler.js"></script>
</head>

<style>
    #cy {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0px;
        left: 0px;
    }
</style>

<body>
    <div id="cy"></div>
    <script>
        window.set = new Set();
        var lastPosition = -1;
        var policeArray = [];

        function initCriminal(quantity) {
            if (isGraphFull()) {
                return;
            }
            while (quantity > 0) {
                quantity--;
                var position = getRandomPosition();
                // var position = 12;
                window.criminal = {
                    id: 'crim',
                    position: position
                }
                nodePopulation[position] = 2;
                cy.style()
                    .selector('#' + position)
                    .style({
                        'background-color': 'red'
                    })
                    .update();
            }
        }
        function initPolice(quantity) {
            if (isGraphFull()) {
                return;
            }
            while (quantity > 0) {
                quantity--;
                policeCount++;
                // if(policeCount == 0){
                //     position = 7;
                // }else{
                //     position = 2;
                // }
                position = getRandomPosition();
                set.add(position);
                var police = {
                    id: 'police' + policeCount.toString(),
                    position: position
                }
                policeArray.push(police);
                nodePopulation[position] = 1;
                cy.style()
                    .selector('#' + position)
                    .style({
                        'background-color': 'blue'
                    }) 
                    .update();
            }
        }
        function getRandomPosition() {
            var position;
            do {
                position = Math.floor((Math.random() * responseNodes.length));
            }
            while (set.has(position));
            set.add(position);
            return position
        }

        function isGraphFull() {
            if (set.size >= responseNodes.length) {
                return true;
            } else {
                return false;
            }
        }

        function placeEdgeLabels() {
            responseGraph.forEach(edge => {
                var edge_id = '#' + edge.begin.toString() + '_' + edge.end.toString();
                cy.style()
                    .selector(edge_id)
                    .style({
                        'label': edge.weight.toString(),
                        'font-size' : 8,
                        width : 1.5,
                    }).update();
            });
        }

        function verifyIntercept(criminalPosition) {
            for (var i = 0; i < policeArray.length; i++) {
                if (criminalPosition == policeArray[i].position) {
                    var anim = createNodeAnimation(criminalPosition, 500, 'green');
                    anim.play();
                    return false;
                }
            }
            return true;
        }

        function createNodeAnimation(idNode, time, color) {
            var animation = cy.$('#' + idNode).animation({
                style: {
                    backgroundColor: color,
                }
            }, {
                duration: time
            });
            return animation;
        }

        function createEdgeAnimation(idNode1, idNode2, time, color){
            var animation = cy.$('#' + idNode1.toString() + '_' + idNode2.toString()).animation({
                style: {
                    'line-color': color.toString(),
                },
                duration: time
            });
            animation.play();
            return animation;
        }

        function animateTransition(idNode1, idNode2, peso, type) {
            var animDuration = peso * 500;
            animationPartTime = animDuration / 2;

            var color = null;
            if (type == 'police') {
                color = 'blue';
            }
            else if (type == 'crim') {
                color = 'red';
            }
            var turnOffAnimation = createNodeAnimation(idNode1, animationPartTime, 'grey');
            var turnOnAnimation = createNodeAnimation(idNode2, animationPartTime, color);
            turnOnAnimation.play();
            turnOffAnimation.play();
        }

        function createRandomMovement(actualPosition) {
            var newPosition = Math.floor((Math.random() * graph_list[actualPosition].length));
            return graph_list[actualPosition][newPosition];
        }

        function moveCriminal() {
            if (verifyIntercept(criminal.position)) {
                var pos;
                var weight;
                var actualPosition;
                var newPosition;
                actualPosition = criminal.position;
                
                var options = graph_list[actualPosition];
                // do{
                //     newPosition = Number(Object.keys(options.pop())[0]);
                // }while(newPosition == lastPosition);
                
                console.log(options)
                do {
                    newPosition = createRandomMovement(criminal.position);
                } while (newPosition == lastPosition);
                
                if (graph_matrix[actualPosition][newPosition] != 'null') {
                    weight = graph_matrix[actualPosition][newPosition];
                }
                else if (graph_matrix[newPosition][actualPosition] != 'null') {
                    weight = graph_matrix[newPosition][actualPosition];
                }
                lastPosition = actualPosition;
                criminal.position = newPosition;

                nodePopulation[actualPosition] = 0;
                nodePopulation[newPosition] = 2;

                animateTransition(actualPosition, newPosition, weight, "crim");
                createEdgeAnimation(actualPosition,newPosition,500,'red');
                createEdgeAnimation(newPosition,actualPosition,500,'red');
                setTimeout(moveCriminal, weight * 500);
            }
        }

        function movePolice(id) {
            var pos;
            var weight;
            var actualPosition;
            var newPosition;

            if(verifyIntercept(criminal.position)){
                actualPosition = policeArray[id].position;
                newPosition = floyd[actualPosition][criminal.position][0];
                
                if(nodePopulation[newPosition] == 1){
                    var options = graph_list[actualPosition];
                    var adjacentDistances = [];
                    options.forEach(
                        (element) => {
                            adjacentDistances.push({
                                [element] : dist[element][criminal.position]
                            });
                        }
                    );
                    adjacentDistances.sort(
                        (a,b) => {
                            let keyA = Object.keys(a);
                            let keyB = Object.keys(b);
                            return a[keyA] - b[keyB];
                        }
                    );
                    var notFound = true;
                    do{
                        newPosition = Number(Object.keys(adjacentDistances.shift())[0]);
                        if(nodePopulation[newPosition] == 0){
                            notFound = false;
                            break;
                        }
                    }while(adjacentDistances.length > 0);
                    if(notFound){
                        newPosition = actualPosition;
                    }
                }

                if(graph_matrix[newPosition][actualPosition] != 'null'){
                    weight = graph_matrix[newPosition][actualPosition];
                }else if(graph_matrix[actualPosition][newPosition] != 'null'){
                    weight = graph_matrix[actualPosition][newPosition];
                }

                policeArray[id].position = newPosition;
                if(actualPosition != newPosition){
                    nodePopulation[actualPosition] = 0;
                    nodePopulation[newPosition] = 1;
                }
                animateTransition(actualPosition, newPosition, weight, 'police');
                createEdgeAnimation(actualPosition,newPosition,500,'blue');
                createEdgeAnimation(newPosition,actualPosition,500,'blue');
                setTimeout(movePolice, weight * 500, id);
            }
        }

        function startSeeker() {
            moveCriminal();
            for(var i=0; i<policeArray.length; i++){
                movePolice(i);
            }
        }

        jQuery.ajax({
            url: 'http://127.0.0.1:5000/graph/clean/',
            success: function (result) {
                window.responseGraph = result.graph.arcList;
                window.responseNodes = result.nodes;
                window.graph_matrix = result.graph_matrix;
                window.graph_list = result.graph_list;
                window.floyd = result.floyd;
                window.dist = result.dist;
                window.responseElements = [];
                window.policeCount = 0;
                window.nodePopulation = [];
                responseNodes.forEach(node => {
                    responseElements.push(
                        {
                            data: { id: node.toString() }
                        }
                    );
                    nodePopulation.push(0);
                });
                responseGraph.forEach(edge => {
                    if (edge.begin != edge.end) {
                        var data_id = edge.begin.toString() + '_' + edge.end.toString();
                        responseElements.push(
                            {
                                data: {
                                    id: data_id,
                                    source: edge.begin.toString(),
                                    target: edge.end.toString()
                                }
                            }
                        );
                    }
                });
                window.cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: responseElements,
                    layout : {
                        name : 'euler',
                        randomize : true,
                        animate : false,
                    },
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'label': 'data(id)',
                                shape: 'ellipse',
                                width : 10,
                                height : 10,
                                'font-size' : 7
                            }
                        }
                    ]
                    
                });

                initCriminal(1);
                initPolice(2);
                placeEdgeLabels();
                startSeeker();
                //Inserir código a partir daqui
            }
        });

    </script>
</body>

</html>